name: ğŸš€ CI/CD Pipeline - PetTrack Microservices

on:
  push:
    branches: [main]

env:
  TAG: latest
  APP_NAME: PetTrackContainer
  COMPOSE_FILE: docker-compose.yml

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # ================================
    # ğŸ”¹ Checkout del cÃ³digo fuente
    # ================================
    - name: Checkout code
      uses: actions/checkout@v4

    # ================================
    # ğŸ” Login a Azure
    # ================================
    - name: Azure login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # ================================
    # ğŸ§© Crear archivos .env desde los secrets
    # ================================
    - name: Create .env files from secrets
      run: |
        echo "ğŸ“¦ Creando archivos .env para cada microservicio..."

        mkdir -p services/api-gateway services/auth-service services/pets-service services/appointment-service certs

        echo "${{ secrets.ENV_API_GATEWAY }}" > services/api-gateway/.env
        echo "${{ secrets.ENV_AUTH_SERVICE }}" > services/auth-service/.env
        echo "${{ secrets.ENV_PETS_SERVICE }}" > services/pets-service/.env
        echo "${{ secrets.ENV_APPOINTMENT_SERVICE }}" > services/appointment-service/.env

        echo "${{ secrets.AZURE_CA_CERT }}" > certs/BaltimoreCyberTrustRoot.pem

        echo "âœ… Archivos .env y certificado creados correctamente"

    # ================================
    # ğŸ³ Login al Azure Container Registry
    # ================================
    - name: Docker login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    # ================================
    # âš™ï¸ Build de imÃ¡genes Docker (sin cachÃ©)
    # ================================
    - name: Build Docker images (no cache)
      run: |
        echo "ğŸ—ï¸ Construyendo imÃ¡genes Docker sin cachÃ©..."
        docker compose -f $COMPOSE_FILE build --no-cache
        echo "âœ… Build completado sin cachÃ©"

    # ================================
    # ğŸ“¦ Push de imÃ¡genes al ACR (forzado)
    # ================================
    - name: Push Docker images to Azure Container Registry
      run: |
        echo "ğŸ“¤ Subiendo todas las imÃ¡genes al Azure Container Registry (forzado)..."
        docker compose -f $COMPOSE_FILE push --ignore-push-failures
        echo "âœ… Push completado correctamente (sin skip)"
