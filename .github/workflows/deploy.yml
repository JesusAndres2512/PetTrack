name: üöÄ CI/CD - PetTrack Monorepo (Matrix Build)

on:
  push:
    branches: ["main"]

env:
  TAG: latest
  COMMIT_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - api-gateway
          - auth-service
          - pets-service
          - appointment-service
          - rewards-service
          - postconsult-service
          - web-client

    steps:
    # -------------------------
    # Checkout
    # -------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # -------------------------
    # Azure Login
    # -------------------------
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # -------------------------
    # Docker login to ACR
    # -------------------------
    - name: Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    # -------------------------
    # Build Image
    # -------------------------
    - name: Build Docker image ‚Äì ${{ matrix.service }}
      run: |
        SERVICE=${{ matrix.service }}
        REGISTRY=${{ secrets.ACR_LOGIN_SERVER }}

        echo "üõ†Ô∏è Construyendo $SERVICE..."

        docker build \
          --no-cache \
          -t $REGISTRY/pettrack-$SERVICE:${TAG} \
          -t $REGISTRY/pettrack-$SERVICE:${COMMIT_TAG} \
          ./services/$SERVICE || ./clients/$SERVICE

    # -------------------------
    # Push Image
    # -------------------------
    - name: Push Docker image ‚Äì ${{ matrix.service }}
      run: |
        SERVICE=${{ matrix.service }}
        REGISTRY=${{ secrets.ACR_LOGIN_SERVER }}

        echo "üì§ Pushing $SERVICE..."

        docker push $REGISTRY/pettrack-$SERVICE:${TAG}
        docker push $REGISTRY/pettrack-$SERVICE:${COMMIT_TAG}

        echo "‚úîÔ∏è Imagen enviada: $SERVICE"
