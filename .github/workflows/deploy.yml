name: üöÄ CI/CD Pipeline - PetTrack Microservices

on:
  push:
    branches: [main]

env:
  TAG: latest
  COMMIT_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Crear certificado desde secret (evita subirlo al repo)
    - name: Crear certificado DigiCert
      run: |
        mkdir -p ./services/auth-service/certs
        echo "${{ secrets.AZURE_CA_CERT }}" > ./services/auth-service/certs/DigiCertGlobalRootG2.crt.pem

        mkdir -p ./services/pets-service/certs
        echo "${{ secrets.AZURE_CA_CERT }}" > ./services/pets-service/certs/DigiCertGlobalRootG2.crt.pem
        
        mkdir -p ./services/appointment-service/certs
        echo "${{ secrets.AZURE_CA_CERT }}" > ./services/appointment-service/certs/DigiCertGlobalRootG2.crt.pem

        mkdir -p ./services/postconsult-service/certs
        echo "${{ secrets.AZURE_CA_CERT }}" > ./services/rewards-service/certs/DigiCertGlobalRootG2.crt.pem

    # 3Ô∏è‚É£ Login a Azure usando Service Principal
    - name: Azure login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 4Ô∏è‚É£ Login al ACR
    - name: Docker login to ACR
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    # 5Ô∏è‚É£ Build y tag de Docker images
    - name: Build and tag Docker images
      run: |
        REGISTRY=${{ secrets.ACR_LOGIN_SERVER }}
        echo "Construyendo im√°genes..."

        docker build --no-cache -t $REGISTRY/pettrack-auth-service:${{ env.TAG }} ./services/auth-service
        docker build --no-cache -t $REGISTRY/pettrack-pets-service:${{ env.TAG }} ./services/pets-service
        docker build --no-cache -t $REGISTRY/pettrack-appointment-service:${{ env.TAG }} ./services/appointment-service
        docker build --no-cache -t $REGISTRY/pettrack-rewards-service:${{ env.TAG }} ./services/rewards-service
        docker build --no-cache -t $REGISTRY/pettrack-postconsult-service:${{ env.TAG }} ./services/postconsult-service
        docker build --no-cache -t $REGISTRY/pettrack-web-client:${{ env.TAG }} ./clients/web-client

        # Etiquetas con commit SHA
        docker tag $REGISTRY/pettrack-auth-service:${{ env.TAG }} $REGISTRY/pettrack-auth-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-pets-service:${{ env.TAG }} $REGISTRY/pettrack-pets-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-appointment-service:${{ env.TAG }} $REGISTRY/pettrack-appointment-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-rewards-service:${{ env.TAG }} $REGISTRY/pettrack-rewards-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-postconsult-service:${{ env.TAG }} $REGISTRY/pettrack-postconsult-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-web-client:${{ env.TAG }} $REGISTRY/pettrack-web-client:${{ env.COMMIT_TAG }}

    # 6Ô∏è‚É£ Push de las im√°genes a ACR
    - name: Push images to ACR
      run: |
        REGISTRY=${{ secrets.ACR_LOGIN_SERVER }}

        docker push $REGISTRY/pettrack-auth-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-pets-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-appointment-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-rewards-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-postconsult-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-web-client:${{ env.TAG }}

        docker push $REGISTRY/pettrack-auth-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-pets-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-appointment-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-rewards-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-postconsult-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-web-client:${{ env.COMMIT_TAG }}
